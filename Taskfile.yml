# https://taskfile.dev

version: '3'

vars:
  GREETING: Hello, World!
  PORT: 8888
  # SHELL: '{{if eq .OS "Windows_NT"}}pwsh{{end}}'

tasks:
  do: # just do it
    deps: [stop, run-background, test, cleanup]

  stop:
    desc: Stop processes running on port {{.PORT}}
    cmds:
      - pwsh -c Write-Host "[LOG] Force stopping any processes running on {{.PORT}}..."
      - pwsh -File ./stop-server.ps1 -Port {{.PORT}}

  list:
    desc: List all available tasks
    cmds:
      - task -l

  default:
    desc: Default task (shows help)
    cmds:
      - task --list

  create-env:
    desc: Create micromamba environment
    cmds:
      # - pwsh -c 'try { gi ./Taskfile.yml } catch { throw "not in project root" }
      - pwsh -c 'Remove-Item -Recurse -Force ./jupyterlab_commands/labextension/'
      - pwsh -c wsl micromamba.exe create -n jl -f ./build-environment.without-ext.yml -y
      - pwsh -c 'wsl micromamba.exe run -n jl uv pip install . --force-reinstall'
    # sources: Task will only run if build-environment.without-ext.yml changes
    sources:
      - build-environment.without-ext.yml
      - 'js/src/**'


  # rebuilds and runs the server
  run:
    desc: run the server (foreground - blocks)
    deps: [stop, create-env]
    cmds:
      - pwsh -c 'Write-Host "[WARN] prefixing commands with wsl for windows environment"'
      - pwsh -File ./start-server.ps1
      # - pwsh -File ./Test-ConsoleErrors.ps1

  test:
    cmds:
      - pwsh -File ./Test-ConsoleErrors.ps1

  cleanup:
    desc: Stop server after tests
    cmds:
      - pwsh -File ./stop-server.ps1 -Port {{.PORT}}
